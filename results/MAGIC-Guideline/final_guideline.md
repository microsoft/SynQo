# SQL Query Correction Guidelines

This document serves as a guideline for correcting SQL queries based on specific feedback. It aims to help in identifying common mistakes and providing a structured approach to rectify them, ensuring the queries accurately fulfill the requirements.

## Guideline Format:

[number]. **[Reminder of Mistake]**
   - Question: \"Question\"
   - **Incorrect SQL generated by me**: ```Incorrect SQL```
   - **Corrected SQL generated by me**: ```sql Corrected SQL```
   - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 

## Recent Mistakes and Corrections:

1. **Limit Clause Omission**
   - Question: \"Name movie titles released in year 1945. Sort the listing by the descending order of movie popularity.\"
   - **Incorrect SQL generated by me**: ```SELECT movie_title FROM movies WHERE movie_release_year = 1945 ORDER BY movie_popularity DESC;```
   - **Corrected SQL generated by me**: ```sql SELECT movie_title FROM movies WHERE movie_release_year = 1945 ORDER BY movie_popularity DESC LIMIT 1;```
   - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
     - Did I consider if the question specifies a limit on the number of results?
     - Have I checked if the results need to be restricted to meet the question's requirements?

2. **Incorrect Filtering Condition**
   - Question: \"Find the professor ID and position in faculty who taught high-level undergraduate course of less than 10 in ID.\"
   - **Incorrect SQL generated by me**: ```SELECT person.p_id, person.hasPosition FROM person INNER JOIN taughtBy ON person.p_id = taughtBy.p_id INNER JOIN course ON taughtBy.course_id = course.course_id WHERE course.courseLevel = 'Level_400' AND course.course_id < 10 AND person.professor = 0```
   - **Corrected SQL generated by me**: ```sql SELECT p.p_id, p.hasPosition FROM person p INNER JOIN taughtBy tb ON p.p_id = tb.p_id INNER JOIN course c ON tb.course_id = c.course_id WHERE c.courseLevel = 'Level_400' AND c.course_id < 10 AND p.professor = 1```
   - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
     - Have I accurately identified and applied the correct filtering conditions based on the question's requirements?
     - Did I verify the logical operators and conditions to ensure they align with the intended query logic?

3. **Misinterpretation of Requirements**
   - Question: \"Among the faculty affiliated professor, how many professors teaches professional or master/undergraduate courses?\"
   - **Incorrect SQL generated by me**: ```SELECT COUNT(DISTINCT T1.p_id) FROM person AS T1 INNER JOIN taughtBy AS T2 ON T1.p_id = T2.p_id INNER JOIN course AS T3 ON T2.course_id = T3.course_id WHERE T1.professor = 0 AND T1.hasPosition = 'Faculty' AND T3.courseLevel = 'Level_500'```
   - **Corrected SQL generated by me**: ```sql SELECT COUNT(DISTINCT T1.p_id) FROM person AS T1 INNER JOIN taughtBy AS T2 ON T1.p_id = T2.p_id INNER JOIN course AS T3 ON T2.course_id = T3.course_id WHERE T1.professor = 1 AND T1.hasPosition = 'Faculty_aff' AND T3.courseLevel = 'Level_500'```
   - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
     - Did I fully understand the question's requirements before writing the query?
     - Have I ensured that all conditions and filters accurately reflect the question's intent?

4. **Incorrect Aggregation and Calculation**
   - Question: \"What is the average number of professional or master/undergraduate courses being taught by each professor?\"
   - **Incorrect SQL generated by me**: ```SELECT COUNT(DISTINCT taughtBy.course_id) / COUNT(DISTINCT taughtBy.p_id) AS average_courses_per_professor FROM taughtBy INNER JOIN course ON taughtBy.course_id = course.course_id WHERE course.courseLevel = 'Level_500'```
   - **Corrected SQL generated by me**: ```sql SELECT AVG(course_count) AS average_courses_per_professor FROM (SELECT COUNT(*) AS course_count FROM taughtBy INNER JOIN course ON taughtBy.course_id = course.course_id WHERE course.courseLevel = 'Level_500' GROUP BY taughtBy.p_id) AS subquery```
   - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
     - Have I used the correct aggregation functions to calculate averages or totals as required by the question?
     - Did I consider using subqueries for complex calculations to ensure accuracy?

5. **Counting Specific Column vs. All Rows**
   - Question: \"How many male users are in the age group of M32-38?\"
   - **Incorrect SQL generated by me**: ```SELECT COUNT(*) FROM gender_age WHERE gender = 'M' AND group = 'M32-38'```
   - **Corrected SQL generated by me**: ```sql SELECT COUNT(gender) FROM gender_age WHERE gender = 'M' AND `group` = 'M32-38'```
   - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
     - Did I use `COUNT(*)` when I should have specified the column I was interested in counting?
     - Have I ensured to use backticks around reserved keywords when they are used as column names?

6. **Directly Targeting the Youngest Age**
   - Question: \"What is the gender of the youngest user?\"
   - **Incorrect SQL generated by me**: ```SELECT gender FROM gender_age ORDER BY age ASC LIMIT 1```
   - **Corrected SQL generated by me**: ```sql SELECT gender FROM gender_age WHERE age = (SELECT MIN(age) FROM gender_age)```
   - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
     - Did I consider the most efficient way to directly target the desired value?
     - Have I evaluated if using a subquery could provide a more accurate and efficient solution?

7. **Ordering and Limiting for Maximum Value Retrieval**
   - Question: \"What is the age of the oldest active user that participated in the event held on 5/6/2016 at coordinates 121, 31?\"
   - **Incorrect SQL generated by me**: ```SELECT MAX(gender_age.age) FROM gender_age INNER JOIN events ON gender_age.device_id = events.device_id INNER JOIN app_events ON events.event_id = app_events.event_id WHERE app_events.is_active = 1 AND events.timestamp LIKE '2016-05-06%' AND events.longitude = 121 AND events.latitude = 31```
   - **Corrected SQL generated by me**: ```sql SELECT gender_age.age FROM gender_age INNER JOIN events_relevant AS er ON gender_age.device_id = er.device_id INNER JOIN app_events ON er.event_id = app_events.event_id WHERE app_events.is_active = 1 AND SUBSTR(er.timestamp, 1, 10) = '2016-05-06' AND er.longitude = 121 AND er.latitude = 31 ORDER BY gender_age.age DESC LIMIT 1```
   - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
     - Did I correctly use ordering and limiting to retrieve the maximum or minimum value?
     - Have I ensured the conditions and joins are accurately targeting the required data?

8. **Manual Calculation of Average**
   - Question: \"What is the average score of the movie 'The Fall of Berlin' in 2019?\"
   - **Incorrect SQL generated by me**: ```SELECT AVG(rating_score) FROM ratings INNER JOIN movies ON ratings.movie_id = movies.movie_id WHERE movies.movie_title = 'The Fall of Berlin' AND rating_timestamp_utc LIKE '2019%'```
   - **Corrected SQL generated by me**: ```sql SELECT CASE WHEN COUNT(r.rating_id) = 0 THEN NULL ELSE SUM(r.rating_score) / COUNT(r.rating_id) END AS average_score FROM ratings AS r INNER JOIN movies AS m ON r.movie_id = m.movie_id WHERE m.movie_title = 'The Fall of Berlin' AND r.rating_timestamp_utc >= '2019-01-01' AND r.rating_timestamp_utc < '2020-01-01'```
   - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
     - Have I considered performing manual calculations for more control over the result?
     - Did I use precise date filtering methods to ensure accuracy?

9. **Simplifying Date Filtering**
   - Question: \"Indicate the location of all the events that occurred on April 30, 2016.\"
   - **Incorrect SQL generated by me**: ```SELECT * FROM table WHERE timestamp BETWEEN '2016-04-30 00:00:00' AND '2016-04-30 23:59:59'```
   - **Corrected SQL generated by me**: ```sql SELECT longitude, latitude FROM events WHERE date(timestamp) = '2016-04-30'```
   - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
     - Did I consider the simplest and most effective method for date filtering?
     - Have I avoided unnecessary complexity in filtering by date and time?

10. **Incorrect Table and Condition Use for App Installation Analysis**
    - Question: \"On which brand of phone are the most applications installed?\"
    - **Incorrect SQL generated by me**: ```SELECT T1.phone_brand, COUNT(*) AS installed_count FROM phone_brand_device_model2 AS T1 JOIN events AS T2 ON T1.device_id = T2.device_id JOIN app_events AS T3 ON T2.event_id = T3.event_id WHERE T3.is_installed = 1 GROUP BY T1.phone_brand ORDER BY installed_count DESC LIMIT 1```
    - **Corrected SQL generated by me**: ```sql SELECT T1.phone_brand, COUNT(*) AS active_count FROM phone_brand_device_model2 AS T1 JOIN events_relevant AS T2 ON T1.device_id = T2.device_id JOIN app_events_relevant AS T3 ON T2.event_id = T3.event_id WHERE T3.is_active = 1 GROUP BY T1.phone_brand ORDER BY active_count DESC LIMIT 1```
    - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
      - Did I ensure to use the correct tables that contain the relevant data for my analysis?
      - Have I correctly identified the condition that matches the question's intent (active vs. installed)?

11. **Misuse of DISTINCT in Counting Unique Device IDs**
    - Question: \"How many men under the age of 23 have apps installed but are not active on their devices?\"
    - **Incorrect SQL generated by me**: ```SELECT COUNT(DISTINCT gender_age.device_id) FROM gender_age INNER JOIN events ON gender_age.device_id = events.device_id INNER JOIN app_events ON events.event_id = app_events.event_id WHERE gender_age.gender = 'M' AND gender_age.age < 23 AND app_events.is_installed = 1 AND app_events.is_active = 0```
    - **Corrected SQL generated by me**: ```sql SELECT COUNT(gender_age.device_id) FROM gender_age INNER JOIN events_relevant ON gender_age.device_id = events_relevant.device_id INNER JOIN app_events_relevant ON events_relevant.event_id = app_events_relevant.event_id WHERE gender_age.gender = 'M' AND gender_age.age < 23 AND app_events_relevant.is_active = 0```
    - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
      - Did I unnecessarily use `DISTINCT` when the query logic or data model does not require it?
      - Have I ensured that my joins and conditions accurately reflect the data's structure and the question's intent?

12. **Date Filtering and Table Naming for Event Analysis**
    - Question: \"Which gender logged in the most to an event in the first 10 days of May 2016?\"
    - **Incorrect SQL generated by me**: ```SELECT gender, COUNT(*) AS login_count FROM gender_age INNER JOIN events ON gender_age.device_id = events.device_id WHERE timestamp BETWEEN '2016-05-01 00:00:00' AND '2016-05-10 23:59:59' GROUP BY gender ORDER BY login_count DESC LIMIT 1```
    - **Corrected SQL generated by me**: ```sql SELECT T.gender, COUNT(T.device_id) AS login_count FROM (SELECT gender_age.gender, gender_age.device_id FROM gender_age INNER JOIN events_relevant ON gender_age.device_id = events_relevant.device_id WHERE date(events_relevant.timestamp) BETWEEN '2016-05-01' AND '2016-05-10') AS T GROUP BY T.gender ORDER BY login_count DESC LIMIT 1```
    - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
      - Did I use the most accurate method for date filtering to match the question's requirements?
      - Have I selected the correct tables and used aliases for clarity and efficiency in my query?

13. **Accuracy in Calculating Average Age for Specific Conditions**
    - Question: \"Calculate the average age of people who have apps installed but are not active on their devices.\"
    - **Incorrect SQL generated by me**: ```SELECT AVG(ga.age) AS average_age FROM gender_age ga JOIN events e ON ga.device_id = e.device_id JOIN app_events ae ON e.event_id = ae.event_id WHERE ae.is_installed = 1 AND ae.is_active = 0;```
    - **Corrected SQL generated by me**: ```sql SELECT AVG(gender_age.age) FROM gender_age JOIN events_relevant ON gender_age.device_id = events_relevant.device_id JOIN app_events_relevant ON events_relevant.event_id = app_events_relevant.event_id WHERE app_events_relevant.is_installed = 1 AND app_events_relevant.is_active = 0```
    - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
      - Have I ensured to use the correct tables for a more accurate analysis?
      - Did I correctly apply conditions to match the specific scenario described in the question?

14. **Selecting Specific Columns for Efficiency**
    - Question: \"Please list any three events that happened on the 1st of May 2016 that have the same latitude of 31.\"
    - **Incorrect SQL generated by me**: ```SELECT * FROM events WHERE timestamp LIKE '2016-05-01%' AND latitude = 31 LIMIT 3```
    - **Corrected SQL generated by me**: ```sql SELECT event_id FROM events WHERE timestamp LIKE '2016-05-01%' AND latitude = 31 LIMIT 3```
    - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
      - Did I only select the columns necessary for the question's requirements, ensuring efficiency?
      - Have I used the correct filtering criteria to accurately target the desired data?

15. **Correcting Device ID and Aggregation Method**
    - Question: \"What is the difference between the events of device number -9222956879900150000 that can be located and those that are unable to be located?\"
    - **Incorrect SQL generated by me**: ```SELECT (SUM(CASE WHEN latitude != 0 AND longitude != 0 THEN 1 ELSE 0 END) - SUM(CASE WHEN latitude = 0 AND longitude = 0 THEN 1 ELSE 0 END)) AS location_difference FROM events WHERE device_id = -9222956879900150000;```
    - **Corrected SQL generated by me**: ```sql SELECT SUM(IIF(latitude != 0 AND longitude != 0, 1, 0)) - SUM(IIF(latitude = 0 AND longitude = 0, 1, 0)) AS difference FROM events WHERE device_id = '-922956879900150000'```
    - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
      - Did I verify the accuracy of key identifiers such as device IDs before executing the query?
      - Have I utilized the most efficient aggregation method to achieve the desired calculation?

16. **Table Naming and Alias Usage for Clarity**
    - Question: \"Show the avatar of the user who gave the rating at 2019/10/17 1:36:36.\"
    - **Incorrect SQL generated by me**: ```SELECT ratings_users.user_avatar_image_url FROM ratings INNER JOIN ratings_users ON ratings.user_id = ratings_users.user_id WHERE ratings.rating_timestamp_utc = '2019-10-17 01:36:36'```
    - **Corrected SQL generated by me**: ```sql SELECT lists_users.user_avatar_image_url FROM ratings INNER JOIN lists_users ON ratings.user_id = lists_users.user_id WHERE ratings.rating_timestamp_utc = '2019-10-17 01:36:36'```
    - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
      - Have I ensured to reference the correct tables as per the question's context?
      - Did I use aliases where appropriate to enhance the readability and clarity of my query?

17. **Direct Counting Without Unnecessary Distinct**
    - Question: \"How many users belong to the same behavior category as comics?\"
    - **Incorrect SQL generated by me**: ```SELECT COUNT(DISTINCT T1.app_id) FROM app_labels AS T1 INNER JOIN label_categories AS T2 ON T1.label_id = T2.label_id WHERE T2.category = 'comics'```
    - **Corrected SQL generated by me**: ```sql SELECT COUNT(app_id) FROM app_labels INNER JOIN label_categories ON app_labels.label_id = label_categories.label_id WHERE category = 'comics'```
    - **Negative and strict step-by-step ask-to-myself questions to prevent the same mistake again**: 
      - Did I unnecessarily use `DISTINCT` when the query logic does not require it?
      - Have I ensured that my conditions accurately target the required data without adding unnecessary complexity?
